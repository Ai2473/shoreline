package com.caspian.client.impl.module.exploit;

import com.caspian.client.api.config.Config;
import com.caspian.client.api.config.setting.BooleanConfig;
import com.caspian.client.api.config.setting.NumberConfig;
import com.caspian.client.api.event.EventStage;
import com.caspian.client.api.event.listener.EventListener;
import com.caspian.client.api.module.ModuleCategory;
import com.caspian.client.api.module.ToggleModule;
import com.caspian.client.impl.event.TickEvent;
import com.caspian.client.impl.event.network.PacketEvent;
import net.minecraft.network.packet.Packet;
import net.minecraft.network.packet.c2s.play.KeepAliveC2SPacket;
import net.minecraft.network.packet.c2s.play.PlayPongC2SPacket;
import net.minecraft.network.packet.c2s.play.ResourcePackStatusC2SPacket;

import java.util.concurrent.ConcurrentHashMap;
import java.util.concurrent.ConcurrentMap;

/**
 *
 *
 * @author linus
 * @since 1.0
 */
public class FakeLatencyModule extends ToggleModule
{
    //
    Config<Float> latencyConfig = new NumberConfig<>("Latency", "Delay in ms " +
            "to add to the client ping", 10.0f, 100.0f, 500.0f);
    Config<Boolean> transactionsConfig = new BooleanConfig("Transactions",
            "Handle server transaction packets", false);
    //
    private final ConcurrentMap<Packet<?>, Long> cachedPackets =
            new ConcurrentHashMap<>();

    /**
     *
     */
    public FakeLatencyModule()
    {
        super("FakeLatency", "Spoofs packet delays to make it appear to the " +
                        "server that you have a higher latency", ModuleCategory.EXPLOITS);
    }

    /**
     *
     */
    @Override
    public void onDisable()
    {
        if (mc.player == null)
        {
            return;
        }
        if (!cachedPackets.isEmpty())
        {
            cachedPackets.forEach((packet, time) ->
                    mc.player.networkHandler.sendPacket(packet));
            cachedPackets.clear();
        }
    }

    /**
     *
     *
     * @param event
     */
    @EventListener
    public void onPacketOutbound(PacketEvent.Outbound event)
    {
        if (mc.player == null)
        {
            return;
        }
        if (!mc.isInSingleplayer())
        {
            if (event.getPacket() instanceof KeepAliveC2SPacket
                    || ((event.getPacket() instanceof ResourcePackStatusC2SPacket
                    || event.getPacket() instanceof PlayPongC2SPacket) && transactionsConfig.getValue()))
            {
                if (cachedPackets.containsKey(event.getPacket()))
                {
                    cachedPackets.remove(event.getPacket());
                    return;
                }
                cachedPackets.put(event.getPacket(), System.currentTimeMillis());
                event.cancel();
            }
        }
    }

    /**
     *
     * @param event
     */
    @EventListener
    public void onTick(TickEvent event)
    {
        if (event.getStage() != EventStage.PRE)
        {
            return;
        }
        //
        cachedPackets.forEach((packet, time) ->
        {
            long elapsed = System.currentTimeMillis() - time;
            if (elapsed > latencyConfig.getValue())
            {
                mc.player.networkHandler.sendPacket(packet);
                cachedPackets.remove(packet);
            }
        });
    }
}
