package net.shoreline.client.impl.module.exploit;

import net.minecraft.entity.projectile.FireworkRocketEntity;
import net.minecraft.network.packet.c2s.play.PlayPongC2SPacket;
import net.minecraft.network.packet.s2c.play.EntitiesDestroyS2CPacket;
import net.minecraft.util.math.Vec3d;
import net.shoreline.client.api.event.listener.EventListener;
import net.shoreline.client.api.module.ModuleCategory;
import net.shoreline.client.api.module.ToggleModule;
import net.shoreline.client.impl.event.TickEvent;
import net.shoreline.client.impl.event.entity.projectile.RemoveFireworkEvent;
import net.shoreline.client.impl.event.network.PacketEvent;
import net.shoreline.client.mixin.accessor.AccessorFireworkRocketEntity;

/**
 *
 *
 * @author Shoreline
 * @since 1.0
 */
public class ExtendedFireworkModule extends ToggleModule
{
    private Vec3d pos;
    private boolean extendFirework;
    private FireworkRocketEntity firework;

    /**
     *
     */
    public ExtendedFireworkModule()
    {
        super("ExtendedFirework", "Extends firework duration",
                ModuleCategory.EXPLOITS);
    }

    @Override
    public void onDisable()
    {
        if (firework != null)
        {
            ((AccessorFireworkRocketEntity) firework).hookExplodeAndRemove();
        }
        pos = null;
        firework = null;
        extendFirework = false;
    }

    @EventListener
    public void onRemoveFirework(RemoveFireworkEvent event)
    {
        if (mc.player.isFallFlying())
        {
            extendFirework = true;
            event.cancel();
            firework = event.getRocketEntity();
            if (pos == null)
            {
                pos = firework.getPos();
            }
        }
    }

    @EventListener
    public void onTick(TickEvent event)
    {
        if (!mc.player.isFallFlying() || pos != null && mc.player.squaredDistanceTo(pos) > 22500)
        {
            extendFirework = false;
            if (firework != null)
            {
                ((AccessorFireworkRocketEntity) firework).hookExplodeAndRemove();
                firework = null;
                pos = null;
            }
        }
    }

    @EventListener
    public void onPacketOutbound(PacketEvent.Outbound event)
    {
        if (mc.player == null || mc.world == null)
        {
            return;
        }
        if (event.getPacket() instanceof PlayPongC2SPacket
                && extendFirework && mc.player.isFallFlying())
        {
            event.cancel();
        }
    }

    @EventListener
    public void onPacketInbound(PacketEvent.Inbound event)
    {
        if (mc.player == null || mc.world == null)
        {
            return;
        }
        if (event.getPacket() instanceof EntitiesDestroyS2CPacket packet
                && extendFirework && mc.player.isFallFlying())
        {
            for (int id : packet.getEntityIds())
            {
                if (id == firework.getId())
                {
                    event.cancel();
                    return;
                }
            }
        }
    }
}